# docker-compose.encrypted-clicker.yml
version: '3.8'

services:
  paw-encrypted-clicker:
    build:
      context: ./paw/modules/encrypted_clicking
      dockerfile: Dockerfile.encrypted
    image: paw-encrypted-clicker:latest
    container_name: paw_encrypted_click_analyzer
    volumes:
      - ./cases:/app/cases:rw
      - ./encrypted_storage:/encrypted_storage:rw
    environment:
      - CRYPTO_PASSWORD=${CLICKER_CRYPTO_PASSWORD:-default_secure_password}
      - PAW_CASE_ID=${CASE_ID:-default_case}
    network_mode: "none"
    isolation: "process"
    mem_limit: 512m
    cpus: 0.5
    restart: "no"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m

  # Servizio per gestione chiavi crittografiche
  paw-crypto-keystore:
    image: vault:latest
    container_name: paw_crypto_keystore
    ports:
      - "8200:8200"
    environment:
      - VAULT_DEV_ROOT_TOKEN_ID=paw_secure_token
      - VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:8200
    volumes:
      - ./vault_data:/vault/data
    cap_add:
      - IPC_LOCK
    security_opt:
      - no-new-privileges:true
    restart: unless-stopped

  # Servizio di monitoraggio e logging
  paw-clicker-monitor:
    image: fluent/fluent-bit:latest
    container_name: paw_clicker_monitor
    volumes:
      - ./cases:/app/cases:ro
      - ./fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf:ro
    depends_on:
      - paw-encrypted-clicker
    restart: unless-stopped